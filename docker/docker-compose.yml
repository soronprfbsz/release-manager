services:
  mariadb:
    image: mariadb:10.11.5
    container_name: sb-mariadb
    ports:
      - "0.0.0.0:${MARIADB_PORT}:3306"
    command:
      - "--default-authentication-plugin=mysql_native_password"
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_general_ci"
      - --slow-query-log=1
      - --long-query-time=5
      - --slow-query-log-file=/var/log/mysql/slow-query.log
    volumes:
      - /data/mariadb/log:/var/lib/mysql
      - /data/mariadb/data:/var/log/mysql
      - ./docker/init-mariadb.sql:/docker-entrypoint-initdb.d/init.sql
    restart: always
    networks:
      - network-ts
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_USER: ${MARIADB_USERNAME}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  redis:
    image: redis:latest
    container_name: sb-redis
    ports:
      - "0.0.0.0:${REDIS_PORT}:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --appendfilename "appendonly.aof" --dir /data
    volumes:
      - redis_data:/data
    networks:
      - network-ts
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  app:
    image: ts/spring-boilerplate:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: ${SERVER_NAME}
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Docker 전용 오버라이드 (컨테이너 네트워킹)
      MARIADB_URL: jdbc:p6spy:mariadb://mariadb:3306/${MARIADB_DATABASE}
      REDIS_HOST: sb-redis
      # JVM 설정
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:+UseG1GC"
    ports:
      - "${SERVER_PORT}:8081"
      - "${GRPC_PORT}:9090"
    networks:
      - network-ts
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --no-verbose --tries=1 --spider http://localhost:$${SERVER_PORT}/actuator/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

networks:
  network-ts:
    external: true

volumes:
  mariadb_data:
  mariadb_log:
  redis_data:
