# ========================================
# GitLab CI/CD Pipeline Configuration (Template-based)
# ========================================

default:
  image: docker:24-cli

variables:
  # App
  SERVER_NAME: "release-manager-api"
  SERVER_HOST: "10.110.1.106"
  SERVER_PORT: "8081"
  SERVER_EXTERNAL_PORT: "18080"
  FLYWAY_ENABLED: "true"
  MARIADB_HOST: "${SERVER_HOST}"
  MARIADB_PORT: "13306"
  MARIADB_DATABASE: "release_manager"
  REDIS_HOST: "${SERVER_HOST}"
  REDIS_PORT: "16379"
  RELEASE_DIR: "/mnt/release-manager/resources"
  JWT_SECRET: "your-secret-key-at-least-256-bits-long-for-hs256-algorithm"

  # Docker Image
  DOCKER_IMAGE_NAME: "ts/${SERVER_NAME}"
  DOCKER_IMAGE_TAG: "latest"

  # Harbor Registry
  HARBOR_IMAGE_NAME: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${SERVER_NAME}"

  # Gradle
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.caching=true"
  GRADLE_USER_HOME: $CI_PROJECT_DIR/.gradle

stages:
  - build
  - test
  - docker-build
  - deploy

# ========================================
# ê³µí†µ í…œí”Œë¦¿ ì •ì˜
# ========================================

# ë¹Œë“œ ê³µí†µ í…œí”Œë¦¿
.build-template:
  stage: build
  image: gradle:8.5-jdk17-alpine
  cache:
    # ë¸Œëžœì¹˜ë³„ ìºì‹œ ì‚¬ìš©
    key: gradle-${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper/       # Gradle wrapper ìºì‹œ
      - .gradle/caches/        # ì˜ì¡´ì„± ìºì‹œ
      - build/classes/         # ì»´íŒŒì¼ëœ í´ëž˜ìŠ¤ ìºì‹œ
      - build/generated/       # ìƒì„±ëœ ì†ŒìŠ¤ ìºì‹œ
      - build/resources/       # ë¦¬ì†ŒìŠ¤ ìºì‹œ
    policy: pull-push
  before_script:
    # Gradle ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
    - mkdir -p .gradle
  script:
    - gradle build -x test --build-cache --no-daemon
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 hour

# í…ŒìŠ¤íŠ¸ ê³µí†µ í…œí”Œë¦¿
.test-template:
  stage: test
  image: gradle:8.5-jdk17-alpine
  cache:
    key: gradle-${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
    policy: pull
  script:
    - gradle test --build-cache --no-daemon
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/
      - build/reports/
    expire_in: 1 weeks
  coverage: '/Total.*?([0-9]{1,3})%/'
  when: manual

# Docker ë¹Œë“œ ê³µí†µ í…œí”Œë¦¿
.docker-build-template:
  stage: docker-build
  variables:
    DOCKER_BUILDKIT: "1"
    BUILDKIT_PROGRESS: "plain"
  before_script:
    - echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin || echo "âš ï¸  Harbor ë¡œê·¸ì¸ ì‹¤íŒ¨"
  script:
    - |
      echo "=== Harbor ì´ë¯¸ì§€ ì¡´ìž¬ í™•ì¸ ==="
      HARBOR_IMAGE_SHA="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${SERVER_NAME}:${CI_COMMIT_SHORT_SHA}"

      if docker manifest inspect ${HARBOR_IMAGE_SHA} > /dev/null 2>&1; then
        echo "âœ“ Harborì— ì´ë¯¸ì§€ ì¡´ìž¬: ${HARBOR_IMAGE_SHA}"
        echo "â­ï¸  ë¹Œë“œ ìŠ¤í‚µ"
        exit 0
      fi

      echo "âŒ Harborì— ì´ë¯¸ì§€ ì—†ìŒ â†’ ë¹Œë“œ ì‹œìž‘..."
      docker build \
        -f docker/Dockerfile.ci \
        -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from ${DOCKER_IMAGE_NAME}:latest \
        --progress=plain \
        --force-rm \
        .

    - 'echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"'
    - docker images | grep ${DOCKER_IMAGE_NAME}

# Harbor Push ê³µí†µ í…œí”Œë¦¿
.harbor-push-template:
  stage: deploy
  before_script:
    - echo "ðŸ”‘ Harbor ë¡œê·¸ì¸ ì¤‘..."
    - echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin
  script:
    - |
      echo "=== Harbor Push í™•ì¸ ==="
      VERSION=${VERSION:-$CI_COMMIT_SHORT_SHA}
      echo "ðŸ“¦ ì‚¬ìš©í•  ë²„ì „: ${VERSION}"
      LOCAL_IMAGE="${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"

      if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^${LOCAL_IMAGE}$"; then
        echo "âœ“ ë¡œì»¬ ì´ë¯¸ì§€ ì¡´ìž¬ â†’ Harborì— Push ì‹œìž‘"

        echo "ðŸ·ï¸  ì´ë¯¸ì§€ íƒœê¹…..."
        docker tag ${LOCAL_IMAGE} ${HARBOR_IMAGE_NAME}:${VERSION}
        docker tag ${LOCAL_IMAGE} ${HARBOR_IMAGE_NAME}:latest

        echo "â¬†ï¸  Harborì— Push ì¤‘..."
        docker push ${HARBOR_IMAGE_NAME}:${VERSION}
        docker push ${HARBOR_IMAGE_NAME}:latest

        echo "ðŸ—‘ï¸  í˜¸ìŠ¤íŠ¸ì—ì„œ Harbor íƒœê·¸ ì´ë¯¸ì§€ ì‚­ì œ..."
        docker rmi ${HARBOR_IMAGE_NAME}:${VERSION} || true
        docker rmi ${HARBOR_IMAGE_NAME}:latest || true

        echo "âœ… ì´ë¯¸ì§€ê°€ Harborì— ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "  - ${HARBOR_IMAGE_NAME}:${VERSION}"
        echo "  - ${HARBOR_IMAGE_NAME}:latest"
        echo "âœ… í˜¸ìŠ¤íŠ¸ì—ëŠ” ${LOCAL_IMAGE}ë§Œ ìœ ì§€ë©ë‹ˆë‹¤"
      else
        echo "â­ï¸  ë¡œì»¬ ì´ë¯¸ì§€ ì—†ìŒ (ë¹Œë“œ ìŠ¤í‚µë¨) â†’ Push ìŠ¤í‚µ"
        echo "â„¹ï¸  docker-build-jobì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì´ë¯¸ Harborì— ì´ë¯¸ì§€ê°€ ì¡´ìž¬í•©ë‹ˆë‹¤"
      fi
  after_script:
    - docker logout $HARBOR_REGISTRY || true

# ë°°í¬ ê³µí†µ í…œí”Œë¦¿
.deploy-template:
  stage: deploy
  before_script:
    - apk add --no-cache curl rsync
    - |
      echo "SERVER_NAME=${SERVER_NAME}" > .env
      echo "SERVER_HOST=${SERVER_HOST}" >> .env
      echo "SERVER_PORT=${SERVER_PORT}" >> .env
      echo "SERVER_EXTERNAL_PORT=${SERVER_EXTERNAL_PORT}" >> .env
      echo "FLYWAY_ENABLED=${FLYWAY_ENABLED}" >> .env
      echo "MARIADB_HOST=${MARIADB_HOST}" >> .env
      echo "MARIADB_PORT=${MARIADB_PORT}" >> .env
      echo "MARIADB_DATABASE=${MARIADB_DATABASE}" >> .env
      echo "MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}" >> .env
      echo "MARIADB_USERNAME=${MARIADB_USERNAME}" >> .env
      echo "MARIADB_PASSWORD=${MARIADB_PASSWORD}" >> .env
      echo "REDIS_HOST=${REDIS_HOST}" >> .env
      echo "REDIS_PORT=${REDIS_PORT}" >> .env
      echo "REDIS_PASSWORD=${REDIS_PASSWORD}" >> .env
      echo "JWT_SECRET=${JWT_SECRET}" >> .env
      echo "RELEASE_DIR=${RELEASE_DIR}" >> .env
      echo "RELEASE_BASE_PATH=/app/resources" >> .env
      echo "DOCKER_IMAGE=${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}" >> .env
    - docker network ls | grep -q network-ts || docker network create network-ts
    - echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin || true
  script:
    - |
      # JARì—ì„œ ë¦¬ì†ŒìŠ¤ íŒŒì¼ ì¶”ì¶œ ë° ë™ê¸°í™”
      echo "=== ë¦¬ì†ŒìŠ¤ íŒŒì¼ ë™ê¸°í™” ==="
      JAR_FILE=$(ls build/libs/*.jar 2>/dev/null | head -1)
      TEMP_DIR="/tmp/release_extract_$$"

      if [ -f "$JAR_FILE" ]; then
        mkdir -p ${TEMP_DIR}
        unzip -q -o "$JAR_FILE" "BOOT-INF/classes/release-manager/*" -d ${TEMP_DIR} 2>/dev/null || true

        if [ -d "${TEMP_DIR}/BOOT-INF/classes/release-manager" ]; then
          rsync -av ${TEMP_DIR}/BOOT-INF/classes/release-manager/ ${RELEASE_DIR}/
          echo "âœ… ë¦¬ì†ŒìŠ¤ ë™ê¸°í™” ì™„ë£Œ"
        fi
        rm -rf ${TEMP_DIR}
      fi
      chmod -R 755 ${RELEASE_DIR}

    - |
      echo "=== ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ==="
      docker-compose -p release_manager -f docker/docker-compose.yml rm -f mariadb redis app || true

    - |
      # ì»¨í…Œì´ë„ˆ ì‹œìž‘ í•¨ìˆ˜
      start_service() {
        local name=$1 container=$2 service=$3
        echo "=== ${name} ì‹œìž‘ ==="
        if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
          echo "âœ“ ${name} ì‹¤í–‰ ì¤‘"
        elif docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
          docker start ${container} && echo "âœ“ ${name} ìž¬ì‹œìž‘ë¨"
        else
          docker-compose -p release_manager -f docker/docker-compose.yml up -d ${service} && echo "âœ“ ${name} ìƒì„±ë¨"
        fi
      }
      start_service "MariaDB" "release-manager-mariadb" "mariadb"
      start_service "Redis" "release-manager-redis" "redis"

    - |
      # í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜
      health_check() {
        local name=$1 container=$2 cmd=$3 max=${4:-60}
        echo "=== ${name} í—¬ìŠ¤ì²´í¬ ==="
        attempt=0
        until eval "$cmd" || [ $attempt -eq $max ]; do
          attempt=$((attempt+1))
          echo "  ${name} ëŒ€ê¸° ì¤‘... ($attempt/$max)"
          sleep 3
        done
        if [ $attempt -eq $max ]; then
          echo "âœ— ${name} í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          docker logs --tail 20 ${container}
          exit 1
        fi
        echo "âœ“ ${name} ì¤€ë¹„ ì™„ë£Œ (${attempt}íšŒ ì‹œë„)"
      }
      health_check "MariaDB" "release-manager-mariadb" "docker exec release-manager-mariadb healthcheck.sh --connect --innodb_initialized"
      health_check "Redis" "release-manager-redis" "docker exec release-manager-redis redis-cli -a '${REDIS_PASSWORD}' ping 2>/dev/null | grep -q PONG"

    - |
      echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ==="
      docker stop ${SERVER_NAME} || true
      docker rm -f ${SERVER_NAME} || true
      docker-compose -p release_manager -f docker/docker-compose.yml up -d --no-deps app
      sleep 10

    - |
      # ì•± í—¬ìŠ¤ì²´í¬
      max=60; attempt=0
      until curl -sf http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}/actuator/health > /dev/null || [ $attempt -eq $max ]; do
        attempt=$((attempt+1))
        echo "  App ëŒ€ê¸° ì¤‘... ($attempt/$max)"
        sleep 3
      done
      if [ $attempt -eq $max ]; then
        echo "âœ— App í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
        docker logs --tail 50 ${SERVER_NAME}
        exit 1
      fi
      echo "âœ… ë°°í¬ ì„±ê³µ (${attempt}íšŒ, $((attempt * 3))ì´ˆ)"

  after_script:
    - docker image prune -f 2>/dev/null || true
    - docker ps --filter "name=${SERVER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# ========================================
# Main ë¸Œëžœì¹˜ ì „ìš© Jobë“¤
# ========================================

build-main:
  extends: .build-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  environment:
    name: production

test-main:
  extends: .test-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  environment:
    name: production

docker-build-main:
  extends: .docker-build-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - build-main
  environment:
    name: production

harbor-push-main:
  extends: .harbor-push-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - docker-build-main
  environment:
    name: production

deploy-main:
  extends: .deploy-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - build-main
    - docker-build-main
  environment:
    name: production
    url: http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}
