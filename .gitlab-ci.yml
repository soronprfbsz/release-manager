# ========================================
# GitLab CI/CD Pipeline Configuration (Template-based)
# ========================================

default:
  image: docker:24-cli

variables:
  # Docker Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
  DOCKER_IMAGE_NAME: "ts/${SERVER_NAME}"
  DOCKER_IMAGE_TAG: "latest"

  # Harbor Registry ÏÑ§Ï†ï (ÏÑ†ÌÉùÏ†Å)
  HARBOR_IMAGE_NAME: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${SERVER_NAME}"

  # Gradle ÏÑ§Ï†ï (ÏµúÏ†ÅÌôî)
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.caching=true"
  GRADLE_USER_HOME: $CI_PROJECT_DIR/.gradle

stages:
  - build
  - test
  - docker-build
  - deploy

# ========================================
# Í≥µÌÜµ ÌÖúÌîåÎ¶ø Ï†ïÏùò
# ========================================

# ÎπåÎìú Í≥µÌÜµ ÌÖúÌîåÎ¶ø
.build-template:
  stage: build
  image: gradle:8.5-jdk17-alpine
  cache:
    # Î∏åÎûúÏπòÎ≥Ñ Ï∫êÏãú ÏÇ¨Ïö©
    key: gradle-${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper/       # Gradle wrapper Ï∫êÏãú
      - .gradle/caches/        # ÏùòÏ°¥ÏÑ± Ï∫êÏãú
      - build/classes/         # Ïª¥ÌååÏùºÎêú ÌÅ¥ÎûòÏä§ Ï∫êÏãú
      - build/generated/       # ÏÉùÏÑ±Îêú ÏÜåÏä§ Ï∫êÏãú
      - build/resources/       # Î¶¨ÏÜåÏä§ Ï∫êÏãú
    policy: pull-push
  before_script:
    # Gradle Ï∫êÏãú ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
    - mkdir -p .gradle
  script:
    - echo "üì¶ ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú ÏãúÏûë..."
    - gradle build -x test --build-cache --no-daemon
    - echo "‚úÖ ÎπåÎìú ÏôÑÎ£å"
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 hour

# ÌÖåÏä§Ìä∏ Í≥µÌÜµ ÌÖúÌîåÎ¶ø
.test-template:
  stage: test
  image: gradle:8.5-jdk17-alpine
  cache:
    key: gradle-${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
    policy: pull
  script:
    - echo "üß™ ÌÖåÏä§Ìä∏ Ïã§Ìñâ Ï§ë..."
    - gradle test --build-cache --no-daemon
    - echo "‚úÖ ÌÖåÏä§Ìä∏ ÏôÑÎ£å"
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/
      - build/reports/
    expire_in: 1 weeks
  coverage: '/Total.*?([0-9]{1,3})%/'
  when: manual

# Docker ÎπåÎìú Í≥µÌÜµ ÌÖúÌîåÎ¶ø
.docker-build-template:
  stage: docker-build
  variables:
    DOCKER_BUILDKIT: "1"
    BUILDKIT_PROGRESS: "plain"
  before_script:
    - echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin || echo "‚ö†Ô∏è  Harbor Î°úÍ∑∏Ïù∏ Ïã§Ìå®"
  script:
    - |
      echo "=== Harbor Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨ ÌôïÏù∏ ==="
      HARBOR_IMAGE_SHA="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${SERVER_NAME}:${CI_COMMIT_SHORT_SHA}"

      if docker manifest inspect ${HARBOR_IMAGE_SHA} > /dev/null 2>&1; then
        echo "‚úì HarborÏóê Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨: ${HARBOR_IMAGE_SHA}"
        echo "‚è≠Ô∏è  ÎπåÎìú Ïä§ÌÇµ"
        exit 0
      fi

      echo "‚ùå HarborÏóê Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå ‚Üí ÎπåÎìú ÏãúÏûë..."
      docker build \
        -f docker/Dockerfile.ci \
        -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from ${DOCKER_IMAGE_NAME}:latest \
        --progress=plain \
        --force-rm \
        .

    - 'echo "‚úÖ Ïù¥ÎØ∏ÏßÄ ÎπåÎìú ÏôÑÎ£å: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"'
    - docker images | grep ${DOCKER_IMAGE_NAME}

# Harbor Push Í≥µÌÜµ ÌÖúÌîåÎ¶ø
.harbor-push-template:
  stage: deploy
  before_script:
    - echo "üîë Harbor Î°úÍ∑∏Ïù∏ Ï§ë..."
    - echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin
  script:
    - |
      echo "=== Harbor Push ÌôïÏù∏ ==="
      VERSION=${VERSION:-$CI_COMMIT_SHORT_SHA}
      echo "üì¶ ÏÇ¨Ïö©Ìï† Î≤ÑÏ†Ñ: ${VERSION}"
      LOCAL_IMAGE="${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"

      if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^${LOCAL_IMAGE}$"; then
        echo "‚úì Î°úÏª¨ Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨ ‚Üí HarborÏóê Push ÏãúÏûë"

        echo "üè∑Ô∏è  Ïù¥ÎØ∏ÏßÄ ÌÉúÍπÖ..."
        docker tag ${LOCAL_IMAGE} ${HARBOR_IMAGE_NAME}:${VERSION}
        docker tag ${LOCAL_IMAGE} ${HARBOR_IMAGE_NAME}:latest

        echo "‚¨ÜÔ∏è  HarborÏóê Push Ï§ë..."
        docker push ${HARBOR_IMAGE_NAME}:${VERSION}
        docker push ${HARBOR_IMAGE_NAME}:latest

        echo "üóëÔ∏è  Ìò∏Ïä§Ìä∏ÏóêÏÑú Harbor ÌÉúÍ∑∏ Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú..."
        docker rmi ${HARBOR_IMAGE_NAME}:${VERSION} || true
        docker rmi ${HARBOR_IMAGE_NAME}:latest || true

        echo "‚úÖ Ïù¥ÎØ∏ÏßÄÍ∞Ä HarborÏóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!"
        echo "  - ${HARBOR_IMAGE_NAME}:${VERSION}"
        echo "  - ${HARBOR_IMAGE_NAME}:latest"
        echo "‚úÖ Ìò∏Ïä§Ìä∏ÏóêÎäî ${LOCAL_IMAGE}Îßå Ïú†ÏßÄÎê©ÎãàÎã§"
      else
        echo "‚è≠Ô∏è  Î°úÏª¨ Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå (ÎπåÎìú Ïä§ÌÇµÎê®) ‚Üí Push Ïä§ÌÇµ"
        echo "‚ÑπÔ∏è  docker-build-jobÏù¥ Ïã§ÌñâÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò Ïù¥ÎØ∏ HarborÏóê Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï°¥Ïû¨Ìï©ÎãàÎã§"
      fi
  after_script:
    - docker logout $HARBOR_REGISTRY || true

# Î∞∞Ìè¨ Í≥µÌÜµ ÌÖúÌîåÎ¶ø
.deploy-template:
  stage: deploy
  before_script:
    - |
      echo "=== ÌïÑÏàò ÎèÑÍµ¨ ÏÑ§Ïπò Ï§ë ==="
      apk add --no-cache curl 2>/dev/null || apt-get update && apt-get install -y curl 2>/dev/null || yum install -y curl 2>/dev/null || true
      command -v curl && echo "‚úì curl ÏÑ§ÏπòÎê®" || echo "‚úó curl ÏÑ§Ïπò Ïã§Ìå®"
    - |
      echo "=== Gitlab VariablesÎ°ú .env ÌååÏùº ÏÉùÏÑ± Ï§ë ==="
      env | \
        grep -vE '^(CI_|GITLAB_|FF_|RUNNER_|DOCKER_|DIND_|PATH=|HOME=|HOSTNAME=|PWD=|OLDPWD=|SHELL=|SHLVL=|USER=|_=|LANG=|LC_|TERM=|DEBIAN_|GRADLE_|GIT_)' | \
        grep -v '^CI=' | \
        grep -E '^[A-Z_]+=.+$' > .env

      # Docker ÌôòÍ≤Ω ÏÑ§Ï†ï Ï∂îÍ∞Ä
      echo "DOCKER_IMAGE=${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}" >> .env
      echo "RELEASE_BASE_PATH=/app/release_files" >> .env

      echo "‚úÖ .env ÌååÏùº ÏÉùÏÑ± ÏôÑÎ£å:"
      cat .env
    - |
      echo "=== Docker ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏ ==="
      docker network ls | grep -q network-ts && echo "‚úì network-ts Ï°¥Ïû¨" || (docker network create network-ts && echo "‚úì network-ts ÏÉùÏÑ±")
    - |
      echo "=== Harbor Î°úÍ∑∏Ïù∏ ==="
      echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin || echo "‚ö†Ô∏è  Harbor Î°úÍ∑∏Ïù∏ Ïã§Ìå®"
  script:
    - |
      echo "=== App Ïù¥ÎØ∏ÏßÄ ÌôïÏù∏ ==="
      LOCAL_IMAGE="ts/${SERVER_NAME}:latest"

      if ! docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^${LOCAL_IMAGE}$"; then
        echo "‚ùå Î°úÏª¨ Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§: ${LOCAL_IMAGE}"
        echo "   docker-build-jobÏù¥ Ïã§Ìå®ÌñàÏäµÎãàÎã§"
        exit 1
      fi

      echo "‚úì Î°úÏª¨ Ïù¥ÎØ∏ÏßÄ ÌôïÏù∏: ${LOCAL_IMAGE}"

    # JARÏóêÏÑú Î¶¨ÏÜåÏä§ ÌååÏùº Ï∂îÏ∂ú Î∞è Î≥µÏÇ¨ (ÏµúÏã† ÌååÏùºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏)
    - |
      echo "=== Î¶¨ÏÜåÏä§ ÌååÏùº ÎèôÍ∏∞Ìôî ==="
      RELEASE_DIR="/data/release_manager/release_files"
      JAR_FILE=$(ls build/libs/*.jar | head -1)
      TEMP_EXTRACT_DIR="/tmp/release_extract_$$"

      if [ -f "$JAR_FILE" ]; then
        echo "üì¶ JAR ÌååÏùºÏóêÏÑú Î¶¨ÏÜåÏä§ Ï∂îÏ∂ú Ï§ë: $JAR_FILE"
        mkdir -p ${TEMP_EXTRACT_DIR}

        # JARÏóêÏÑú release ÎîîÎ†âÌÜ†Î¶¨Îßå Ï∂îÏ∂ú
        unzip -q -o "$JAR_FILE" "BOOT-INF/classes/release/*" -d ${TEMP_EXTRACT_DIR} 2>/dev/null || true

        if [ -d "${TEMP_EXTRACT_DIR}/BOOT-INF/classes/release" ]; then
          echo "üìÇ Î¶¨ÏÜåÏä§ ÌååÏùº ÎèôÍ∏∞Ìôî Ï§ë (ÏµúÏã† ÌååÏùºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏)..."

          # rsyncÎ°ú ÌååÏùº ÎèôÍ∏∞Ìôî (Ìï≠ÏÉÅ ÏÜåÏä§Î°ú ÎçÆÏñ¥Ïì∞Í∏∞)
          if command -v rsync > /dev/null 2>&1; then
            rsync -av ${TEMP_EXTRACT_DIR}/BOOT-INF/classes/release/ ${RELEASE_DIR}/
          else
            # rsync ÏóÜÏúºÎ©¥ cpÎ°ú ÎåÄÏ≤¥ (ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞ Ïú†ÏßÄÌïòÎ©∞ Î≥µÏÇ¨, Ìï≠ÏÉÅ ÎçÆÏñ¥Ïì∞Í∏∞)
            cd ${TEMP_EXTRACT_DIR}/BOOT-INF/classes/release
            find . -type f | while read file; do
              dest="${RELEASE_DIR}/${file}"
              mkdir -p "$(dirname "$dest")"
              cp -f "$file" "$dest"
              echo "  Î≥µÏÇ¨: $file"
            done
            cd - > /dev/null
          fi

          echo "‚úÖ Î¶¨ÏÜåÏä§ ÌååÏùº ÎèôÍ∏∞Ìôî ÏôÑÎ£å"
        else
          echo "‚ö†Ô∏è  JARÏóêÏÑú release ÎîîÎ†âÌÜ†Î¶¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
        fi

        # ÏûÑÏãú ÎîîÎ†âÌÜ†Î¶¨ Ï†ïÎ¶¨
        rm -rf ${TEMP_EXTRACT_DIR}
      else
        echo "‚ö†Ô∏è  JAR ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
      fi

      chmod -R 777 ${RELEASE_DIR}
      echo "üìÅ ÏµúÏ¢Ö ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞:"
      ls -laR ${RELEASE_DIR}/ | head -50 || true

    - |
      echo "=== Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨ ==="
      docker-compose -p release_manager -f docker/docker-compose.yml rm -f mariadb redis app || true

    - |
      echo "=== MariaDB ÏãúÏûë ==="
      if docker ps --format '{{.Names}}' | grep -q '^release-manager-mariadb$'; then
        echo "‚úì MariaDB Ïã§Ìñâ Ï§ë"
      elif docker ps -a --format '{{.Names}}' | grep -q '^release-manager-mariadb$'; then
        docker start release-manager-mariadb && echo "‚úì MariaDB Ïû¨ÏãúÏûëÎê®"
      else
        docker-compose -p release_manager -f docker/docker-compose.yml up -d mariadb && echo "‚úì MariaDB ÏÉùÏÑ±Îê®"
      fi

    - |
      echo "=== Redis ÏãúÏûë ==="
      if docker ps --format '{{.Names}}' | grep -q '^release-manager-redis$'; then
        echo "‚úì Redis Ïã§Ìñâ Ï§ë"
      elif docker ps -a --format '{{.Names}}' | grep -q '^release-manager-redis$'; then
        docker start release-manager-redis && echo "‚úì Redis Ïû¨ÏãúÏûëÎê®"
      else
        docker-compose -p release_manager -f docker/docker-compose.yml up -d redis && echo "‚úì Redis ÏÉùÏÑ±Îê®"
      fi

    - |
      echo "=== MariaDB Ìó¨Ïä§Ï≤¥ÌÅ¨ ==="
      max_attempts=60
      attempt=0
      until docker exec release-manager-mariadb healthcheck.sh --connect --innodb_initialized || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        echo "  MariaDB ÎåÄÍ∏∞ Ï§ë... ($attempt/$max_attempts)"
        sleep 3
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "‚úó MariaDB Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®"
        docker logs --tail 20 release-manager-mariadb
        exit 1
      fi
      echo "‚úì MariaDB Ï§ÄÎπÑ ÏôÑÎ£å (${attempt}Ìöå ÏãúÎèÑ)"

    - |
      echo "=== Redis Ìó¨Ïä§Ï≤¥ÌÅ¨ ==="
      max_attempts=60
      attempt=0
      until docker exec release-manager-redis redis-cli -a "${REDIS_PASSWORD}" ping 2>/dev/null | grep -q PONG || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        echo "  Redis ÎåÄÍ∏∞ Ï§ë... ($attempt/$max_attempts)"
        sleep 3
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "‚úó Redis Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®"
        echo "=== Redis Î°úÍ∑∏ ==="
        docker logs --tail 20 release-manager-redis
        echo "=== Redis Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ ==="
        docker exec release-manager-redis redis-cli -a "${REDIS_PASSWORD}" ping 2>&1 || true
        exit 1
      fi
      echo "‚úì Redis Ï§ÄÎπÑ ÏôÑÎ£å (${attempt}Ìöå ÏãúÎèÑ)"

    - |
      echo "=== Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Î∞∞Ìè¨ ==="
      docker stop ${SERVER_NAME} || true
      docker rm -f ${SERVER_NAME} || true
      docker-compose -p release_manager -f docker/docker-compose.yml up -d --no-deps app
      echo "‚úì Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûëÎê®"
      sleep 10

    - |
      echo "=== Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ìó¨Ïä§Ï≤¥ÌÅ¨ ==="
      max_attempts=60
      attempt=0
      until curl -sf http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}/actuator/health > /dev/null || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        echo "  Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÎåÄÍ∏∞ Ï§ë... ($attempt/$max_attempts)"
        sleep 3
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "‚úó Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® (3Î∂Ñ ÌÉÄÏûÑÏïÑÏõÉ)"
        echo "=== Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏ ==="
        docker logs --tail 50 ${SERVER_NAME}
        echo "=== Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ==="
        docker ps -a --filter "name=${SERVER_NAME}"
        exit 1
      fi
      echo "‚úÖ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï§ÄÎπÑ ÏôÑÎ£å (${attempt}Ìöå ÏãúÎèÑ, $((attempt * 3))Ï¥à ÏÜåÏöî)"
      echo "=== Î∞∞Ìè¨ ÏÑ±Í≥µ ==="

  after_script:
    - echo "=== Ï†ïÎ¶¨ ÏûëÏóÖ ==="
    - docker image prune -f --filter "label=project=${SERVER_NAME}" 2>/dev/null || true
    - echo "‚úì ${SERVER_NAME} Dangling Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨ ÏôÑÎ£å"

    - echo "=== Î∞∞Ìè¨ ÏÉÅÌÉú ==="
    - docker ps --filter "name=${SERVER_NAME}" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
    - docker images --filter "reference=${DOCKER_IMAGE_NAME}" --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}"

# ========================================
# Main Î∏åÎûúÏπò Ï†ÑÏö© JobÎì§
# ========================================

build-main:
  extends: .build-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  environment:
    name: production

test-main:
  extends: .test-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  environment:
    name: production

docker-build-main:
  extends: .docker-build-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - build-main
  environment:
    name: production

harbor-push-main:
  extends: .harbor-push-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - docker-build-main
  environment:
    name: production

deploy-main:
  extends: .deploy-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - build-main
    - docker-build-main
  environment:
    name: production
    url: http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}

# ========================================
# Dev Î∏åÎûúÏπò Ï†ÑÏö© JobÎì§
# ========================================

build-dev:
  extends: .build-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  tags:
    - dev-runner
  environment:
    name: development

test-dev:
  extends: .test-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  tags:
    - dev-runner
  environment:
    name: development

docker-build-dev:
  extends: .docker-build-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  tags:
    - dev-runner
  dependencies:
    - build-dev
  environment:
    name: development

harbor-push-dev:
  extends: .harbor-push-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  tags:
    - dev-runner
  dependencies:
    - docker-build-dev
  environment:
    name: development

deploy-dev:
  extends: .deploy-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  tags:
    - dev-runner
  dependencies:
    - build-dev
    - docker-build-dev
  environment:
    name: development
    url: http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}
