# ========================================
# GitLab CI/CD Pipeline Configuration (Template-based)
# ========================================

default:
  image: docker:24-cli

variables:
  # Docker ì´ë¯¸ì§€ ì„¤ì •
  DOCKER_IMAGE_NAME: "ts/release-manager-api"
  DOCKER_IMAGE_TAG: "latest"

  # Harbor Registry ì„¤ì • (ì„ íƒì )
  HARBOR_IMAGE_NAME: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/release-manager-api"

  # Gradle ì„¤ì • (ìµœì í™”)
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.caching=true"
  GRADLE_USER_HOME: $CI_PROJECT_DIR/.gradle

  # ì•± í™˜ê²½ë³€ìˆ˜ ì„¤ì •
  SERVER_NAME: "release-manager-api"
  SERVER_HOST: "10.110.1.106"
  SERVER_PORT: "8081"
  SERVER_EXTERNAL_PORT: "18080"
  FLYWAY_ENABLED: "true"
  MARIADB_HOST: "10.110.1.106"
  MARIADB_PORT: "13306"
  MARIADB_DATABASE: "release_manager"
  REDIS_HOST: "10.110.1.106"
  REDIS_PORT: "16379"
  RELEASE_DIR: "/mnt/release-manager/resources"

stages:
  - build
  - test
  - docker-build
  - deploy

# ========================================
# ê³µí†µ í…œí”Œë¦¿ ì •ì˜
# ========================================

# ë¹Œë“œ ê³µí†µ í…œí”Œë¦¿
.build-template:
  stage: build
  image: gradle:8.5-jdk17-alpine
  cache:
    # ë¸Œëœì¹˜ë³„ ìºì‹œ ì‚¬ìš©
    key: gradle-${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper/       # Gradle wrapper ìºì‹œ
      - .gradle/caches/        # ì˜ì¡´ì„± ìºì‹œ
      - build/classes/         # ì»´íŒŒì¼ëœ í´ë˜ìŠ¤ ìºì‹œ
      - build/generated/       # ìƒì„±ëœ ì†ŒìŠ¤ ìºì‹œ
      - build/resources/       # ë¦¬ì†ŒìŠ¤ ìºì‹œ
    policy: pull-push
  before_script:
    # Gradle ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
    - mkdir -p .gradle
  script:
    - echo "ğŸ“¦ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œì‘..."
    - gradle build -x test --build-cache --no-daemon
    - echo "âœ… ë¹Œë“œ ì™„ë£Œ"
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 hour

# í…ŒìŠ¤íŠ¸ ê³µí†µ í…œí”Œë¦¿
.test-template:
  stage: test
  image: gradle:8.5-jdk17-alpine
  cache:
    key: gradle-${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
    policy: pull
  script:
    - echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
    - gradle test --build-cache --no-daemon
    - echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/
      - build/reports/
    expire_in: 1 weeks
  coverage: '/Total.*?([0-9]{1,3})%/'
  when: manual

# Docker ë¹Œë“œ ê³µí†µ í…œí”Œë¦¿
.docker-build-template:
  stage: docker-build
  variables:
    DOCKER_BUILDKIT: "1"
    BUILDKIT_PROGRESS: "plain"
  before_script:
    - echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin || echo "âš ï¸  Harbor ë¡œê·¸ì¸ ì‹¤íŒ¨"
  script:
    - |
      echo "=== Harbor ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ ==="
      HARBOR_IMAGE_SHA="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${SERVER_NAME}:${CI_COMMIT_SHORT_SHA}"

      if docker manifest inspect ${HARBOR_IMAGE_SHA} > /dev/null 2>&1; then
        echo "âœ“ Harborì— ì´ë¯¸ì§€ ì¡´ì¬: ${HARBOR_IMAGE_SHA}"
        echo "â­ï¸  ë¹Œë“œ ìŠ¤í‚µ"
        exit 0
      fi

      echo "âŒ Harborì— ì´ë¯¸ì§€ ì—†ìŒ â†’ ë¹Œë“œ ì‹œì‘..."
      docker build \
        -f docker/Dockerfile.ci \
        -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from ${DOCKER_IMAGE_NAME}:latest \
        --progress=plain \
        --force-rm \
        .

    - 'echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"'
    - docker images | grep ${DOCKER_IMAGE_NAME}

# Harbor Push ê³µí†µ í…œí”Œë¦¿
.harbor-push-template:
  stage: deploy
  before_script:
    - echo "ğŸ”‘ Harbor ë¡œê·¸ì¸ ì¤‘..."
    - echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin
  script:
    - |
      echo "=== Harbor Push í™•ì¸ ==="
      VERSION=${VERSION:-$CI_COMMIT_SHORT_SHA}
      echo "ğŸ“¦ ì‚¬ìš©í•  ë²„ì „: ${VERSION}"
      LOCAL_IMAGE="${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"

      if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^${LOCAL_IMAGE}$"; then
        echo "âœ“ ë¡œì»¬ ì´ë¯¸ì§€ ì¡´ì¬ â†’ Harborì— Push ì‹œì‘"

        echo "ğŸ·ï¸  ì´ë¯¸ì§€ íƒœê¹…..."
        docker tag ${LOCAL_IMAGE} ${HARBOR_IMAGE_NAME}:${VERSION}
        docker tag ${LOCAL_IMAGE} ${HARBOR_IMAGE_NAME}:latest

        echo "â¬†ï¸  Harborì— Push ì¤‘..."
        docker push ${HARBOR_IMAGE_NAME}:${VERSION}
        docker push ${HARBOR_IMAGE_NAME}:latest

        echo "ğŸ—‘ï¸  í˜¸ìŠ¤íŠ¸ì—ì„œ Harbor íƒœê·¸ ì´ë¯¸ì§€ ì‚­ì œ..."
        docker rmi ${HARBOR_IMAGE_NAME}:${VERSION} || true
        docker rmi ${HARBOR_IMAGE_NAME}:latest || true

        echo "âœ… ì´ë¯¸ì§€ê°€ Harborì— ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "  - ${HARBOR_IMAGE_NAME}:${VERSION}"
        echo "  - ${HARBOR_IMAGE_NAME}:latest"
        echo "âœ… í˜¸ìŠ¤íŠ¸ì—ëŠ” ${LOCAL_IMAGE}ë§Œ ìœ ì§€ë©ë‹ˆë‹¤"
      else
        echo "â­ï¸  ë¡œì»¬ ì´ë¯¸ì§€ ì—†ìŒ (ë¹Œë“œ ìŠ¤í‚µë¨) â†’ Push ìŠ¤í‚µ"
        echo "â„¹ï¸  docker-build-jobì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì´ë¯¸ Harborì— ì´ë¯¸ì§€ê°€ ì¡´ì¬í•©ë‹ˆë‹¤"
      fi
  after_script:
    - docker logout $HARBOR_REGISTRY || true

# ë°°í¬ ê³µí†µ í…œí”Œë¦¿
.deploy-template:
  stage: deploy
  before_script:
    - |
      echo "=== í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ ì¤‘ ==="
      apk add --no-cache curl 2>/dev/null || apt-get update && apt-get install -y curl 2>/dev/null || yum install -y curl 2>/dev/null || true
      command -v curl && echo "âœ“ curl ì„¤ì¹˜ë¨" || echo "âœ— curl ì„¤ì¹˜ ì‹¤íŒ¨"
    - |
      echo "=== Gitlab Variablesë¡œ .env íŒŒì¼ ìƒì„± ì¤‘ ==="
      env | \
        grep -vE '^(CI_|GITLAB_|FF_|RUNNER_|DOCKER_|DIND_|PATH=|HOME=|HOSTNAME=|PWD=|OLDPWD=|SHELL=|SHLVL=|USER=|_=|LANG=|LC_|TERM=|DEBIAN_|GRADLE_|GIT_)' | \
        grep -v '^CI=' | \
        grep -E '^[A-Z_]+=.+$' > .env

      # Docker í™˜ê²½ ì„¤ì • ì¶”ê°€
      echo "DOCKER_IMAGE=${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}" >> .env
      echo "RELEASE_BASE_PATH=/app/resources" >> .env

      echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ:"
      cat .env
    - |
      echo "=== Docker ë„¤íŠ¸ì›Œí¬ í™•ì¸ ==="
      docker network ls | grep -q network-ts && echo "âœ“ network-ts ì¡´ì¬" || (docker network create network-ts && echo "âœ“ network-ts ìƒì„±")
    - |
      echo "=== Harbor ë¡œê·¸ì¸ ==="
      echo "$HARBOR_PASSWORD" | docker login http://$HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin || echo "âš ï¸  Harbor ë¡œê·¸ì¸ ì‹¤íŒ¨"
  script:
    - |
      # 1. í™˜ê²½ ë³€ìˆ˜ ì„ ì–¸ (gitlab-ci variables -> docker-compose)
      export RELEASE_DIR=${RELEASE_DIR}
      export SERVER_NAME=${SERVER_NAME}
      export SERVER_HOST=${SERVER_HOST}
      export SERVER_PORT=${SERVER_PORT}
      export SERVER_EXTERNAL_PORT=${SERVER_EXTERNAL_PORT}
      export FLYWAY_ENABLED=${FLYWAY_ENABLED}
      export MARIADB_HOST=${MARIADB_HOST}
      export MARIADB_PORT=${MARIADB_PORT}
      export MARIADB_DATABASE=${MARIADB_DATABASE}
      export REDIS_HOST=${REDIS_HOST}
      export REDIS_PORT=${REDIS_PORT}

    - |
      # JARì—ì„œ ë¦¬ì†ŒìŠ¤ íŒŒì¼ ì¶”ì¶œ ë° ë³µì‚¬ (ìµœì‹  íŒŒì¼ë¡œ ì—…ë°ì´íŠ¸)
      echo "=== ë¦¬ì†ŒìŠ¤ íŒŒì¼ ë™ê¸°í™” ==="
      JAR_FILE=$(ls build/libs/*.jar | head -1)
      TEMP_EXTRACT_DIR="/tmp/release_extract_$$"

      if [ -f "$JAR_FILE" ]; then
        echo "ğŸ“¦ JAR íŒŒì¼ì—ì„œ ë¦¬ì†ŒìŠ¤ ì¶”ì¶œ ì¤‘: $JAR_FILE"
        mkdir -p ${TEMP_EXTRACT_DIR}

        # JARì—ì„œ release ë””ë ‰í† ë¦¬ë§Œ ì¶”ì¶œ
        unzip -q -o "$JAR_FILE" "BOOT-INF/classes/release-manager/*" -d ${TEMP_EXTRACT_DIR} 2>/dev/null || true

        if [ -d "${TEMP_EXTRACT_DIR}/BOOT-INF/classes/release-manager" ]; then
          echo "ğŸ“‚ ë¦¬ì†ŒìŠ¤ íŒŒì¼ ë™ê¸°í™” ì¤‘ (ìµœì‹  íŒŒì¼ë¡œ ì—…ë°ì´íŠ¸)..."

          # rsyncë¡œ íŒŒì¼ ë™ê¸°í™” (í•­ìƒ ì†ŒìŠ¤ë¡œ ë®ì–´ì“°ê¸°)
          if command -v rsync > /dev/null 2>&1; then
            rsync -av ${TEMP_EXTRACT_DIR}/BOOT-INF/classes/release-manager/ ${RELEASE_DIR}/
          else
            # rsync ì—†ìœ¼ë©´ cpë¡œ ëŒ€ì²´ (ë””ë ‰í† ë¦¬ êµ¬ì¡° ìœ ì§€í•˜ë©° ë³µì‚¬, í•­ìƒ ë®ì–´ì“°ê¸°)
            cd ${TEMP_EXTRACT_DIR}/BOOT-INF/classes/release-manager
            find . -type f | while read file; do
              dest="${RELEASE_DIR}/${file}"
              mkdir -p "$(dirname "$dest")"
              cp -f "$file" "$dest"
              echo "  ë³µì‚¬: $file"
            done
            cd - > /dev/null
          fi

          echo "âœ… ë¦¬ì†ŒìŠ¤ íŒŒì¼ ë™ê¸°í™” ì™„ë£Œ"
        else
          echo "âš ï¸  JARì—ì„œ release ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        fi

        # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
        rm -rf ${TEMP_EXTRACT_DIR}
      else
        echo "âš ï¸  JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
      fi

      chmod -R 777 ${RELEASE_DIR}
      echo "ğŸ“ ìµœì¢… ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
      ls -laR ${RELEASE_DIR}/ | head -50 || true

    - |
      echo "=== ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ==="
      docker-compose -p release_manager -f docker/docker-compose.yml rm -f mariadb redis app || true

    - |
      echo "=== MariaDB ì‹œì‘ ==="
      if docker ps --format '{{.Names}}' | grep -q '^release-manager-mariadb$'; then
        echo "âœ“ MariaDB ì‹¤í–‰ ì¤‘"
      elif docker ps -a --format '{{.Names}}' | grep -q '^release-manager-mariadb$'; then
        docker start release-manager-mariadb && echo "âœ“ MariaDB ì¬ì‹œì‘ë¨"
      else
        docker-compose -p release_manager -f docker/docker-compose.yml up -d mariadb && echo "âœ“ MariaDB ìƒì„±ë¨"
      fi

    - |
      echo "=== Redis ì‹œì‘ ==="
      if docker ps --format '{{.Names}}' | grep -q '^release-manager-redis$'; then
        echo "âœ“ Redis ì‹¤í–‰ ì¤‘"
      elif docker ps -a --format '{{.Names}}' | grep -q '^release-manager-redis$'; then
        docker start release-manager-redis && echo "âœ“ Redis ì¬ì‹œì‘ë¨"
      else
        docker-compose -p release_manager -f docker/docker-compose.yml up -d redis && echo "âœ“ Redis ìƒì„±ë¨"
      fi

    - |
      echo "=== MariaDB í—¬ìŠ¤ì²´í¬ ==="
      max_attempts=60
      attempt=0
      until docker exec release-manager-mariadb healthcheck.sh --connect --innodb_initialized || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        echo "  MariaDB ëŒ€ê¸° ì¤‘... ($attempt/$max_attempts)"
        sleep 3
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "âœ— MariaDB í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
        docker logs --tail 20 release-manager-mariadb
        exit 1
      fi
      echo "âœ“ MariaDB ì¤€ë¹„ ì™„ë£Œ (${attempt}íšŒ ì‹œë„)"

    - |
      echo "=== Redis í—¬ìŠ¤ì²´í¬ ==="
      max_attempts=60
      attempt=0
      until docker exec release-manager-redis redis-cli -a "${REDIS_PASSWORD}" ping 2>/dev/null | grep -q PONG || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        echo "  Redis ëŒ€ê¸° ì¤‘... ($attempt/$max_attempts)"
        sleep 3
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "âœ— Redis í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
        echo "=== Redis ë¡œê·¸ ==="
        docker logs --tail 20 release-manager-redis
        echo "=== Redis ì—°ê²° í…ŒìŠ¤íŠ¸ ==="
        docker exec release-manager-redis redis-cli -a "${REDIS_PASSWORD}" ping 2>&1 || true
        exit 1
      fi
      echo "âœ“ Redis ì¤€ë¹„ ì™„ë£Œ (${attempt}íšŒ ì‹œë„)"

    - |
      echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ==="
      docker stop ${SERVER_NAME} || true
      docker rm -f ${SERVER_NAME} || true
      docker-compose -p release_manager -f docker/docker-compose.yml up -d --no-deps app
      echo "âœ“ ì»¨í…Œì´ë„ˆ ì‹œì‘ë¨"
      sleep 10

    - |
      echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ==="
      max_attempts=60
      attempt=0
      until curl -sf http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}/actuator/health > /dev/null || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        echo "  ì• í”Œë¦¬ì¼€ì´ì…˜ ëŒ€ê¸° ì¤‘... ($attempt/$max_attempts)"
        sleep 3
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "âœ— ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (3ë¶„ íƒ€ì„ì•„ì›ƒ)"
        echo "=== ì»¨í…Œì´ë„ˆ ë¡œê·¸ ==="
        docker logs --tail 50 ${SERVER_NAME}
        echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
        docker ps -a --filter "name=${SERVER_NAME}"
        exit 1
      fi
      echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„ ì™„ë£Œ (${attempt}íšŒ ì‹œë„, $((attempt * 3))ì´ˆ ì†Œìš”)"
      echo "=== ë°°í¬ ì„±ê³µ ==="

  after_script:
    - echo "=== ì •ë¦¬ ì‘ì—… ==="
    - docker image prune -f --filter "label=project=${SERVER_NAME}" 2>/dev/null || true
    - echo "âœ“ ${SERVER_NAME} Dangling ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"

    - echo "=== ë°°í¬ ìƒíƒœ ==="
    - docker ps --filter "name=${SERVER_NAME}" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
    - docker images --filter "reference=${DOCKER_IMAGE_NAME}" --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}"

# ========================================
# Main ë¸Œëœì¹˜ ì „ìš© Jobë“¤
# ========================================

build-main:
  extends: .build-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  environment:
    name: production

test-main:
  extends: .test-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  environment:
    name: production

docker-build-main:
  extends: .docker-build-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - build-main
  environment:
    name: production

harbor-push-main:
  extends: .harbor-push-template
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - docker-build-main
  environment:
    name: production

deploy-main:
  extends: .deploy-template
  variables:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - main-runner
  dependencies:
    - build-main
    - docker-build-main
  environment:
    name: production
    url: http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}
