# ========================================
# GitLab CI/CD Pipeline Configuration
# ========================================

default:
  image: docker:24-cli

variables:
  # Docker ì´ë¯¸ì§€ ì„¤ì •
  DOCKER_IMAGE_NAME: "ts/${SERVER_NAME}"
  DOCKER_IMAGE_TAG: "latest"

  # Harbor Registry ì„¤ì • (ì„ íƒì )
  HARBOR_HOST: "10.230.1.17"
  HARBOR_PROJECT: "release-manager"
  HARBOR_IMAGE_NAME: "${HARBOR_HOST}/${HARBOR_PROJECT}/${SERVER_NAME}"

  # Gradle ì„¤ì •
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: $CI_PROJECT_DIR/.gradle

stages:
  - build
  - test
  - docker-build
  - harbor-push
  - deploy

# ========================================
# ë¹Œë“œ ë‹¨ê³„
# ========================================
build-job:
  stage: build
  image: gradle:8.5-jdk17-alpine
  tags:
    - 17-runner
  only:
    - main
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/
      - build/
  script:
    - echo "í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œì‘..."
    - gradle clean build -x test --no-daemon
    - echo "ë¹Œë“œ ì™„ë£Œ"
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 hour

# ========================================
# í…ŒìŠ¤íŠ¸ ë‹¨ê³„ (ìˆ˜ë™ ì‹¤í–‰)
# ========================================
test-job:
  stage: test
  image: gradle:8.5-jdk17-alpine
  tags:
    - 17-runner
  only:
    - main
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/
  script:
    - echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
    - gradle test --no-daemon
    - echo "í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/
      - build/reports/
    expire_in: 1 weeks
  coverage: '/Total.*?([0-9]{1,3})%/'
  when: manual  # ìˆ˜ë™ ì‹¤í–‰ (í•„ìš”ì‹œì—ë§Œ)

# ========================================
# Docker ì´ë¯¸ì§€ ë¹Œë“œ ë‹¨ê³„ (ë¡œì»¬)
# ========================================
docker-build-job:
  stage: docker-build
  tags:
    - 17-runner
  only:
    - main
  dependencies:
    - build-job
  script:
    - echo "Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
    - docker build -f docker/Dockerfile.ci -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} . --progress=plain --force-rm
    - 'echo "ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"'
    - docker images | grep ${DOCKER_IMAGE_NAME}

# ========================================
# Harbor Push ë‹¨ê³„ (ì„ íƒì )
# ========================================
# Harborì— ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•˜ë ¤ë©´ ì´ Jobì„ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ì„¸ìš”
harbor-push-job:
  stage: harbor-push
  tags:
    - 17-runner
  only:
    - main
  dependencies:
    - docker-build-job
  before_script:
    - echo "Harbor ë¡œê·¸ì¸ ì¤‘..."
    - echo "$HARBOR_PASSWORD" | docker login $HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin
  script:
    - echo "ë¡œì»¬ ì´ë¯¸ì§€ë¥¼ Harbor í˜•ì‹ìœ¼ë¡œ íƒœê¹…..."
    - docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${HARBOR_IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${HARBOR_IMAGE_NAME}:latest
    - echo "Harborì— ì´ë¯¸ì§€ Push ì¤‘..."
    - docker push ${HARBOR_IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - docker push ${HARBOR_IMAGE_NAME}:latest
    - echo "ì´ë¯¸ì§€ê°€ Harborì— ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"
    - echo "  - ${HARBOR_IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
    - echo "  - ${HARBOR_IMAGE_NAME}:latest"
  after_script:
    - docker logout $HARBOR_REGISTRY || true
  when: manual  # ìˆ˜ë™ ì‹¤í–‰ (í•„ìš”ì‹œì—ë§Œ)

# ========================================
# ë°°í¬ ë‹¨ê³„ (GitLab Runner í˜¸ìŠ¤íŠ¸)
# ========================================
deploy-job:
  stage: deploy
  tags:
    - 17-runner
  only:
    - main
  dependencies:
    - docker-build-job
  before_script:
    - |
      echo "=== í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ ì¤‘ ==="
      apk add --no-cache curl 2>/dev/null || apt-get update && apt-get install -y curl 2>/dev/null || yum install -y curl 2>/dev/null || true
      command -v curl && echo "âœ“ curl ì„¤ì¹˜ë¨" || echo "âœ— curl ì„¤ì¹˜ ì‹¤íŒ¨"
    - |
      echo "=== Gitlab Variablesë¡œ .env íŒŒì¼ ìƒì„± ì¤‘ ==="
      env | grep -vE '^(CI=|CI_|GITLAB_|FF_|RUNNER_|DOCKER_|DIND_|PATH=|HOME=|HOSTNAME=|PWD=|OLDPWD=|SHELL=|SHLVL=|USER=|_=|LANG=|LC_|TERM=|DEBIAN_|GRADLE_)' > .env

      # Docker ì´ë¯¸ì§€ ì •ë³´ ì¶”ê°€
      echo "DOCKER_IMAGE=${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}" >> .env

      cat .env
      cp .env docker/.env
    - |
      echo "=== Docker ë„¤íŠ¸ì›Œí¬ í™•ì¸ ==="
      docker network ls | grep -q network-ts && echo "âœ“ network-ts ì¡´ì¬" || (docker network create network-ts && echo "âœ“ network-ts ìƒì„±")
  script:
    # 1. ì´ˆê¸° ë¦´ë¦¬ì¦ˆ íŒŒì¼ ë³µì‚¬ (ìµœì´ˆ ë°°í¬ ì‹œì—ë§Œ)
    - |
      echo "=== ë°°í¬ ì‹œì‘ ==="
      mkdir -p /data/rm/release_files
      if [ ! -f /data/rm/release_files/.initialized ]; then
        # ê¸°ì¡´ íŒŒì¼ ë°±ì—… (í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„)
        if [ -d "/data/rm/release_files/releases" ]; then
          echo "âš ï¸  ê¸°ì¡´ íŒŒì¼ ë°œê²¬, ë°±ì—… ì¤‘..."
          tar czf "/data/rm/release_files_backup_$(date +%Y%m%d_%H%M%S).tar.gz" \
                  -C /data/rm release_files
        fi
        echo "ğŸ“¦ ì´ˆê¸° ë¦´ë¦¬ì¦ˆ íŒŒì¼ ë³µì‚¬ ì¤‘..."
        cp -r src/main/resources/release/* /data/rm/release_files/
        touch /data/rm/release_files/.initialized
        echo "âœ… ì´ˆê¸°í™” ì™„ë£Œ"
      else
        echo "â„¹ï¸  ë¦´ë¦¬ì¦ˆ íŒŒì¼ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ê±´ë„ˆëœ€"
      fi
    - |
      echo "=== ë°°í¬ ì‹œì‘ ==="
      docker-compose -f docker/docker-compose.yml rm -f mariadb redis app || true
    - |
      echo "=== MariaDB ì‹œì‘ ==="
      if docker ps --format '{{.Names}}' | grep -q '^rm-mariadb$'; then
        echo "âœ“ MariaDB ì‹¤í–‰ ì¤‘"
      elif docker ps -a --format '{{.Names}}' | grep -q '^rm-mariadb$'; then
        docker start rm-mariadb && echo "âœ“ MariaDB ì¬ì‹œì‘ë¨"
      else
        docker-compose -f docker/docker-compose.yml up -d mariadb && echo "âœ“ MariaDB ìƒì„±ë¨"
      fi
    - |
      echo "=== Redis ì‹œì‘ ==="
      if docker ps --format '{{.Names}}' | grep -q '^rm-redis$'; then
        echo "âœ“ Redis ì‹¤í–‰ ì¤‘"
      elif docker ps -a --format '{{.Names}}' | grep -q '^rm-redis$'; then
        docker start rm-mariadb && echo "âœ“ Redis ì¬ì‹œì‘ë¨"
      else
        docker-compose -f docker/docker-compose.yml up -d redis && echo "âœ“ Redis ìƒì„±ë¨"
      fi
    - |
      echo "=== MariaDB í—¬ìŠ¤ì²´í¬ ==="
      max_attempts=30
      attempt=0
      until docker exec rm-mariadb healthcheck.sh --connect --innodb_initialized || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        sleep 2
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "âœ— MariaDB í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
        docker logs --tail 20 rm-mariadb
        exit 1
      fi
      echo "âœ“ MariaDB ì¤€ë¹„ ì™„ë£Œ"
    - |
      echo "=== Redis í—¬ìŠ¤ì²´í¬ ==="
      max_attempts=30
      attempt=0
      until docker exec rm-redis redis-cli ping || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        sleep 2
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "âœ— Redis í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
        docker logs --tail 20 rm-redis
        exit 1
      fi
      echo "âœ“ Redis ì¤€ë¹„ ì™„ë£Œ"
    - |
      echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ==="
      docker stop ${SERVER_NAME} || true
      docker rm -f ${SERVER_NAME} || true
      docker-compose -f docker/docker-compose.yml up -d --no-deps app
      echo "âœ“ ì»¨í…Œì´ë„ˆ ì‹œì‘ë¨"
      sleep 10
    - |
      echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ==="
      max_attempts=30
      attempt=0
      until curl -sf http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}/actuator/health > /dev/null || [ $attempt -eq $max_attempts ]; do
        attempt=$((attempt+1))
        echo "  ëŒ€ê¸° ì¤‘... ($attempt/$max_attempts)"
        sleep 2
      done
      if [ $attempt -eq $max_attempts ]; then
        echo "âœ— ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
        docker logs ${SERVER_NAME}
        exit 1
      fi
      echo "âœ“ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„ ì™„ë£Œ"
      echo "=== ë°°í¬ ì„±ê³µ ==="
  after_script:
    - echo "=== ì •ë¦¬ ì‘ì—… ==="
    - docker images -f "dangling=true" -f "label=project=${HARBOR_PROJECT}" -q | xargs -r docker rmi -f 2>/dev/null || true
    - docker image prune -f --filter "label=project=${HARBOR_PROJECT}" --filter "dangling=true" 2>/dev/null || true
    - echo "âœ“ Dangling ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"
    - echo "=== ë°°í¬ ìƒíƒœ ==="
    - docker ps --filter "name=${SERVER_NAME}" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
    - docker images --filter "reference=${DOCKER_IMAGE_NAME}" --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}"
  environment:
    name: production
    url: http://${SERVER_HOST}:${SERVER_EXTERNAL_PORT}
